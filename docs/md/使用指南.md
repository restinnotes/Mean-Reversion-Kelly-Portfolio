# 单标的 LEAPS 凯利仓位管理工具使用指南

> **关联文档**：本工具的数学原理和推导过程请参考《理论白皮书 (PDF)》。

本指南旨在指导用户如何使用 `single_asset_kelly.py` (单标的策略脚本) 来计算基于均值回归和凯利公式的最优 LEAPS 仓位。

---

## 1. 核心理念

我们不预测股价明天的涨跌，而是计算当下的赔率。这个工具回答了三个核心问题：

- **动力 (Drift)**：根据均值回归模型 (OU Process)，股价现在的反弹动力有多大？
- **成本 (Cost)**：为了持有 LEAPS 杠杆，我们需要支付多少"租金" (Theta + 资金成本)？
- **仓位 (Size)**：扣除成本后，如果还有正向优势 (ERP)，根据凯利公式应该下注多少？

---

## 2. 快速开始

### 环境准备

确保你的 Python 环境安装了以下库：

```bash
pip install numpy pandas yfinance
```

### 目录结构

确保脚本可以访问 `code/utils/` 文件夹中的工具：

```text
project_root/
├── code/
│   ├── strategies/
│   │   └── single_asset_kelly.py  # 主程序
│   └── utils/
│       ├── lambda_tools.py        # 计算回归动力
│       └── sigma_tools.py         # 计算真实波动率
└── pe_csv/
    └── NVDA_pe.csv                # 历史 PE 数据 (用于计算 Lambda)
```

### 运行脚本

```bash
python code/strategies/single_asset_kelly.py
```

---

## 3. 参数详解：客观统计 vs. 主观判断

这是本策略最关键的部分。模型的结果取决于输入，输入分为两类：**自动获取的客观数据** 和 **需要你决策的主观参数**。

### A. 自动获取 (Objective Data) —— 📍 不需要你动

程序会自动从 Yahoo Finance 和本地 CSV 计算这些统计特征，代表了市场的客观状态。

| 参数 | 代码变量 | 含义 | 来源 |
|:---|:---|:---|:---|
| 回归速度 | `lambda_annual` | 股价偏离后回归均值的速度。数值越大，修复越快，预期收益越高。 | 基于 pe_csv 数据的 OU 过程拟合 |
| 真实波动 | `sigma_iv` | 标的年化波动率（采用 **稳健估计**）。不再使用简单的历史平均，而是计算过去 5 年数据的 **滚动窗口（252天）波动率**，并取其 **85% 分位数**（或当前波动率的最大值）。这确保了在计算凯利公式分母（风险）时，我们使用的是一个相对保守、能覆盖大部分极端情况的数值，而非被平静期的低波动误导。 | yfinance 获取 5 年数据 -> 滚动计算 |
| 无风险利率 | `r_f` | 资金的机会成本（如 4.1%）。 | 硬编码或 API 获取 |

### B. 市场快照 (Market Snapshot) —— 📍 需手动录入

> ⚠️ **选筹关键规则**
>
> 1. 在录入以下数据前，请先在心中确定 **硬底 ($V_{hard}$)**。
> 2. 你选择的 LEAPS 合约，其 **行权价 (Strike Price)** 应该 **等于或接近** 你设定的硬底。
>
> **原理**：即使股价腰斩，跌破了硬底，你的最大亏损也被行权价锁定了，物理上截断了尾部风险。

你需要打开交易软件（如 IBKR, ThinkOrSwim），找到那张 Strike ≈ $V_{hard}$ 的合约，填入数据：

| 参数 | 代码变量 | 说明 |
|:---|:---|:---|
| 股价 | `P` | 正股当前价格。 |
| 期权价 | `option_price` | 你选定合约 (Strike ≈ Hard Floor) 的最新价格 (Ask Price)。 |
| Delta | `delta` | 该合约的 Delta 值（通常在 0.8 ~ 0.9 之间）。 |
| Theta | `theta_daily_abs` | 该合约的每日 Theta 损耗（取绝对值）。 |

### C. 主观决策 (Subjective Inputs) —— 🎨 你的艺术

这是你需要发挥"投资者洞察力"的地方。这些参数直接决定了仓位的激进程度。

#### 1. 目标价 (V) 与 硬底 (V_hard)

```python
V = 225.00      # 目标价 (Fair Value)
V_hard = 130.00 # 硬底 (Hard Floor) --> 对应 LEAPS 行权价 (Strike)
```

- **V (目标价)**：你认为标的值多少钱？可以是前高、DCF 估值或平均 PE 估值。
  - **影响**：$V$ 越高，预期收益 (Drift) 越高，仓位越大。
- **V_hard (硬底)**：极端悲观情况下，你认为它绝对不会跌破的价格（如历史最低估值支撑）。
  - **影响**：这决定了你的"信心水位"。股价离 $V_{hard}$ 越近，程序给出的 Alpha 信心系数越高，仓位越重。
  - **操作**：请务必买入行权价 (Strike) 在此价格附近的期权。

#### 2. 估值折扣系数 (beta)

```python
beta = 0.2  # 建议范围: 0.2 ~ 0.5
```

- **含义**：当股价上涨接近目标价 $V$ 时，你要多大程度上减少仓位？
- **逻辑**：
  - **0.0**: 死多头模式。即使股价涨到了目标价，Alpha 依然是 1.0，完全不减仓。
  - **1.0**: 极度保守。股价一到目标价，Alpha 变成 0，直接清仓。
  - **0.2**: 推荐值。保留大部分底仓，以此来对抗右侧踏空的风险。

#### 3. 凯利系数 (k)

```python
k = 1.0  # 建议范围: 0.3 ~ 1.0
```

- **含义**：安全边际乘数。
- **用法**：计算结果显示 120% 仓位，如果你觉得太激进，可以将 $k$ 设为 0.5 (半凯利)，结果就会变成 60%。
- **实战建议**：对于单标的，建议 $k$ 不超过 0.7；如果你非常确信且资金充裕，可用 1.0。

---

## 4. 结果解读：如何看报告？

运行脚本后，你会得到一份双语报告。请关注以下核心指标：

### 第一步：看 ERP (净优势)

> LEAPS 净优势 (ERP): 203.74% (扣除 Rf & Theta)

这是扣除了利息和时间损耗后的纯超额收益。

- **如果是负数**：🛑 坚决不开仓。说明预期的反弹动力连支付期权的时间租金都不够。
- **如果是正数**：✅ 说明这是一个数学期望为正的赌局。

### 第二步：看 Alpha (信心水位)

> 当前水位 Risk: 54.9% (Alpha折扣系数 = 0.890)

这告诉你目前股价在 [硬底, 目标] 区间的位置。

- **0.890** 意味着程序建议你只打出理论仓位的 89%，留 11% 的余地防守。

### 第三步：看 建议仓位 (Kelly Suggestion)

> 建议现金投入: $122,506
> 建议购买张数: 18.95 张

这是最终结论。

- **注意**：如果算出的比例 > 100%（如本例），代表机会极好。但在实操中，永远不要使用融资买期权。请将仓位上限卡在 100% 或你账户预设的单标的上限（如 20%）。

---

## 5. 风险提示

- **垃圾进，垃圾出 (GIGO)**：如果你的 $V$ (目标价) 设得太高，或者 $V_{hard}$ (硬底) 设得太低，计算结果会误导你重仓。估值是主观的，请对自己负责。

- **黑天鹅风险**：凯利公式假设历史波动率 (Sigma) 能代表未来。如果未来发生突发性崩盘，实际波动率可能远超计算值。

- **杠杆双刃剑**：LEAPS 虽然长期损耗低，但短期波动巨大。请确保你的心理承受能力能接受 50% 以上的回撤。

---
## 6. 实战核心：为何只选期权？以及如何分批建仓？(Leverage & Scaling)

在实战中，确定了理论优势后，我们必须解决两个执行层面的终极问题：

1.  **工具选择**：既然看好正股，为什么要买有损耗的期权？
2.  **节奏控制**：算出仓位后，是一把梭哈，还是分批进场？

本章节将回归 **"资金效率"与"生存逻辑"**，为您提供一套标准作业程序 (S.O.P.)。

### 6.1 工具选择：为何抛弃正股，独宠 LEAPS？

在这套均值回归策略中，我们只推荐使用 LEAPS，绝不推荐融资买正股。这并非因为期权的持有成本（租金）一定比融资利息低，而是为了拒绝 **"死于黎明前"**。

当我们需要获得超过 100% 的市场敞口（例如 1.6 倍杠杆）时，两者有着本质区别：

| 维度 | 融资买正股 (Margin) | 深度实值 LEAPS | 结论 |
| :--- | :--- | :--- | :--- |
| **杠杆属性** | 有追索权杠杆 (Recourse) | 无追索权杠杆 (Non-recourse) | **LEAPS 胜** |
| **回撤后果** | **爆仓风险 (Margin Call)**<br>跌 30% 可能直接强平归零。 | **最大亏损锁定**<br>即使正股腰斩，亏损仅限权利金，永不强平。 | **LEAPS 完胜** |
| **生存能力** | 必须时刻关注维持保证金，心态极易崩坏。 | 只要不跌破行权价 (硬底)，就能一直持有等待反转。 | **LEAPS 胜** |

> **核心逻辑**
>
> 选择期权的本质，是为了获得 **"自带止损线 (行权价) 的杠杆"**。
>
> * 我们拒绝正股，因为正股加杠杆遇到黑天鹅会死（穿仓）。
> * 我们选择 LEAPS，即使为此支付了一定的 Theta 或隐含融资成本，但这笔钱是值得的——它购买了 **"不死" 的权利**。

### 6.2 资金管理：基于 Kelly 的分批建仓 S.O.P.

既然选择了 LEAPS，下一步就是如何买。

凯利公式算出的数值（例如 120% 或 80%）是一个静态快照，但在实战中，我们必须将其转化为动态的分批建仓计划。

**原则：以终为始。** 在开第一枪之前，你就要想好："如果跌到硬底 ($V_{hard}$)，我要用什么姿势打完最后的子弹？"

我们建议采用 **$k$ 值阶梯战法 ($0.5 \to 1.0$)**：

#### 第一阶段：初次建立底仓 (The Pilot Buy)

* **触发条件**：股价进入低估区，但距离硬底 ($V_{hard}$) 还有距离。
* **设置参数**：`k = 0.5` (半凯利)
* **逻辑**：
    * 此时胜率 ($p$) 和赔率 ($b$) 都不算极致。
    * 使用半凯利，通常会得出一个 40% ~ 60% 的建议仓位。
* **执行**：买入该比例。保留 40%~60% 的现金（购买 SGOV 吃利息）。这笔现金是你的战略后备队。

#### 第二阶段：击穿防线后的加仓 (The All-In Buy)

* **触发条件**：股价继续下跌，逼近或触及硬底 ($V_{hard}$)，市场极度恐慌。
* **设置参数**：`k = 1.0` (全凯利)
* **逻辑**：
    * 此时，$\alpha$ (信心系数) 接近 1.0，ERP (净优势) 达到最大值。
    * 模型会告诉你："这是千载难逢的机会，建议下注 120%！"
* **执行**：动用所有剩余现金，将仓位打满至 100%（物理上限）。

#### 💡 实战推演表

假设你现有资金 $100,000，标的为 NVDA：

| 股价 | 阶段 | 市场状态 | 你的设定 (k) | 模型建议仓位 | 实际操作 | 账户状态 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **$180** | 初步低估 | 纠结下跌 | 0.5 | 60% | 买入 $60k LEAPS | 60% 期权 + 40% 现金 |
| **$160** | 恐慌下跌 | 加速赶底 | 0.7 | 85% | 加仓 $25k LEAPS | 85% 期权 + 15% 现金 |
| **$130** | 触及硬底 | 绝望/至暗 | 1.0 | >100% | **梭哈剩余现金** | 100% 期权 (满仓) |

### 6.3 总结

1.  **不死是第一位的**：不要纠结于期权的租金（Theta）是否比融资利息贵那么一点点。对于个体交易者，**"绝不爆仓"** 的价值是无价的。
2.  **不要一次打满**：模型显示的 100% 仓位是给"确定性最高时刻"准备的。在左侧接飞刀的过程中，请始终从 $k=0.5$ 开始，把 $k=1.0$ 的满仓权利留给真正的"至暗时刻"。
3.  **现金的期权属性**：记住，现金不仅仅是用来买东西的，它本身就是一个看涨期权——让你在未来拥有以更低价格买入优质资产的权利。不要轻易行权（花光现金），除非赔率已经好到无法拒绝 ($k=1$)。

---

## 7. 单资产风险与回撤分析 (Risk & Drawdown Analysis)

在确定了凯利公式建议的仓位后，必须进行风险压力测试。我们提供了一个专门的脚本来回答一个核心问题：**"如果我按照这个仓位买入，明天市场暴跌，我的账户会亏多少？"**

### 7.1 运行风险分析脚本

运行位于 `code/strategies/` 目录下的风险分析脚本 `single_asset_risk.py` ：

```bash
python code/strategies/single_asset_risk.py
```

### 7.2 核心指标解读

脚本输出分为三个关键部分，请务必区分 **标的风险** 与 **账户风险**：

#### A. 资产属性 (The Instrument)

* **有效杠杆 (Effective Leverage)**：
  * 显示为 `L` 倍。例如 2.4x 表示正股跌 1%，期权理论上跌 2.4%。
  * *注意：这是动态的，随着股价下跌，杠杆通常会减小，但 Gamma 风险会增加。*
* **凯利建议仓位 (Kelly Allocation)**：
  * 基于 `k` 值计算出的建议现金比例。
  * 若显示 > 100%，代表模型对该机会极度看好，建议满仓（但在实盘中请限制在 100% 以内或手动降低 k 值）。

#### B. 单日波动 (Volatility)

这是评估"心脏承受力"的关键指标：

1. **LEAPS 自身的单日波动 (Instrument Risk)**
   * **含义**：不管你买多少，这张期权合约本身每天的平均震荡幅度。
   * **参考值**：科技股 LEAPS 通常在 **6% - 10%** 之间。如果某天跌了 7%，这属于"正常波动"，无需惊慌。

2. **您的账户单日风险 (Account Risk)**
   * **含义**：买了之后，**您的总账户**（例如 $100k）每天会波动多少。
   * **公式**：`账户波动 = 仓位比例 × LEAPS波动`
   * **实战红线**：
     * **< 2%**：低风险（类似债基/平衡组合）。
     * **2% - 4%**：激进成长（类似全仓持有 NVDA 正股）。
     * **> 5%**：**极高风险**（类似币圈合约）。如果看到此数值，**必须降低 k 值**。

### 7.3 极端场景推演 (Scenario Analysis)

脚本会模拟基于正态分布的三种概率事件：

| 场景 | 发生概率 | 含义 | 应对心态 |
|:---|:---|:---|:---|
| **常态波动 (1σ)** | ~68% | 每 3 天就会发生一次 | "只是正常的市场噪音，关上软件睡觉。" |
| **月度大跌 (2σ)** | ~95% | 平均一个月发生一次 | "有点疼，但并未破坏上涨趋势，保持关注。" |
| **极端崩盘 (3σ)** | ~99% | 平均一年发生一次 | "黑天鹅事件。如果亏损金额超过心理阈值，说明仓位过重。" |

### 7.4 如何调整风控参数 (k 值)

如果在运行脚本后看到警告：

> `⚠️ 高风险提示：您的账户单日波动 (9.39%) 极大。`

请打开代码文件，找到以下参数进行修改：

```python
# [Strategy Parameters]
k = 1.0   # 默认激进模式 (Full Kelly)
```

**建议调整为：**

* **k = 0.5 (Half Kelly)**：业界标准的长期生存配置。收益是满仓的 75%，但波动率减半。适合大多数激进投资者。
* **k = 0.3**：保守配置。适合由于心理压力无法承受账户单日回撤 >3% 的投资者。

---

**示例对比：**

* **k=1.0**：仓位 120%，账户日波动 9.4%。(一天亏 $9,400) -> **不可接受**
* **k=0.5**：仓位 60%，账户日波动 4.7%。(一天亏 $4,700) -> **激进但可控**

---

### 7.5 实战建议

对于 LEAPS 策略来说，**k=0.5 (Half Kelly)** 通常是最大化长期几何增长率且避免破产的最佳平衡点。因为主观因素（如设定的目标价是否合理？）和黑天鹅的存在，你这个配置能够：

* 保留约 75% 的理论收益
* 将波动率降低至原来的 50%
* 显著提高心理承受能力
* 降低连续亏损导致的永久性资本损失风险

**记住**：凯利公式追求的是长期复利增长，而非单次押注的最大化。生存是第一要务。