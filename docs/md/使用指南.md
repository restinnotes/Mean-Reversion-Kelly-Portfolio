# 单资产 Merton-Kelly 量化策略框架使用指南

**关联文档**：本工具的数学原理和推导过程请参考《理论白皮书 (PDF)》。

本指南旨在指导用户如何使用 `code/strategies/` 下的策略脚本以及 `code/utils/` 下的核心分析工具。我们不仅仅是在计算一个仓位数字，更是在执行一套严谨的**&quot;诊断-计算-风控&quot;**流程。

---

## 1. 核心流程与工具全景

在使用任何策略脚本之前，请先理解我们的标准作业程序 (S.O.P.)。**盲目计算仓位而不验证数学假设（均值回归是否成立）是极其危险的。**

| 步骤 | 对应脚本 | 作用 | 核心问题 |
|------|----------|------|----------|
| **Step 0** | `utils/rolling_analysis.py` | 市场诊断 (Diagnosis) | 现在的 Lambda 是否虚高？回归概率如何？ |
| **Step 0.5** | `strategies/optimal_expiry_solver.py` | 选品辅助 (Advanced) | 到底买哪个月的期权？ |
| **Step 1** | `strategies/single_asset_kelly.py` | 仓位计算 (Sizing) | 核心步骤。基于选定合约，凯利公式建议买多少现金？ |
| **Step 2** | `strategies/single_asset_risk.py` | 压力测试 (Risk Check) | 如果明天暴跌，我会爆仓吗？ |

---

## 2. 环境与准备

### 环境准备

确保你的 Python 环境安装了以下库：

```bash
pip install numpy pandas yfinance matplotlib scipy
```

### 目录结构

确保脚本可以访问 `code/utils/` 文件夹中的工具：

```
project_root/
├── code/
│   ├── strategies/
│   │   ├── optimal_expiry_solver.py   # 最优期限求解器 (进阶)
│   │   ├── single_asset_kelly.py      # 主策略 (核心)
│   │   └── single_asset_risk.py       # 风控 (核心)
│   └── utils/
│       ├── lambda_tools.py            # 计算回归动力 (Lambda)
│       ├── sigma_tools.py             # 计算真实波动 (Sigma)
│       └── rolling_analysis.py        # 滚动回归诊断工具
└── pe_csv/
    └── NVDA_pe.csv                     # 历史 PE 数据 (必须有)
```

## 2.5 进阶工具：量化战术控制台 (Interactive Dashboard)

为了解决命令行工具无法实时调整参数、难以进行敏感性测试的问题，我们提供了一个基于 Web 的可视化控制台。

### 启动方式

在终端运行以下命令：
```bash
streamlit run code/app_dashboard.py
```

浏览器会自动打开一个本地页面（通常是 `http://localhost:8501`）。

### 核心功能

1. 参数实时调优：
   * 你可以直接拖动滑动条调整 `Kelly系数 (k)` 和 `估值折扣 (beta)`，观察仓位建议的实时变化。
   * Lambda/Sigma 缓存：点击一次 "Fetch Historical Stats" 后，数据会被缓存，方便你快速切换查看不同标的。
2. 情景推演 (Scenario Analysis)：
   * 页面底部的折线图回答了一个核心战术问题："如果股价继续下跌，我该加仓还是止损？"
   * 重要逻辑说明：该推演基于** "恒定杠杆重注 (Constant Leverage Re-entry)" ** 假设。
      * 即：模型假设当股价下跌时，你不会死守原有那张已经变成平值(ATM)的高损耗合约，而是会换仓到新的、维持目标杠杆率（如 2.4x）的深度实值合约。
      * 因此，图表展示的是纯粹的** "估值吸引力" **——股价越低，均值回归动力越强，建议仓位越重（呈现左高右低的形态）。
---

## 3. Step 0: 市场诊断 (The Gatekeeper)

**对应脚本**：`code/utils/rolling_analysis.py`

这是最关键的一步。所有的策略都建立在"均值回归"这一假设上。**在计算仓位之前，我们必须先看清市场的"体温"。**

运行该脚本会生成三张关键图表并输出一份统计报告。

### 3.1 视觉诊断：三张图怎么看？(Visual Diagnosis)

脚本运行后会弹出一个包含三个子图的窗口，这是判断** "Lambda 是否虚高" **的核心依据：

#### Top Plot: PE Ratio vs Moving Avg (估值偏离度)

- **看什么**：黑线 (当前PE) 是否显著低于 蓝虚线 (均线)。
- **意义**：确认"低估"是真实的，而不是均线本身在快速下移（价值陷阱）。

#### Middle Plot: Reversion Speed Lambda (回归速度)

- **看什么**：当前的 Lambda (最右端的值) 是否处于历史极高位？
- **警惕**：Lambda 是一个弹性系数。如果股价最近几天剧烈暴跌又暴涨，拟合出来的 Lambda 可能会飙升（例如 > 8.0 甚至 10.0），但这通常是短期波动的噪音。
- **操作**：我们宁可低估动力，不可高估。如果图表显示当前 Lambda 远高于历史平均水平，请在后续 Step 1 计算仓位时，手动调低 Lambda（例如取历史平均值或中位数），以防模型过度乐观。

#### Bottom Plot: Implied Half-Life (半衰期)

- **看什么**：需要多少天才能修复一半的跌幅？
- **意义**：时间是期权的敌人。如果半衰期在历史高位（例如 > 100天），说明近期股性极慢，LEAPS 的 Theta 损耗可能会吃掉利润。

### 3.2 结果解读 (Statistical Report)

运行脚本后，请关注终端输出的概率表，特别是 `[ACTION PLAN]`：

```
[WIN RATE TABLE]
Trading Days  ~Calendar Days  Touch Prob
     126          182d         90.3%
     189          273d         97.4%
------------------------------------------------------------
RECOMMENDATION:
> [STATISTICAL FLOOR] 90% Probability to touch target within:
   126 Trading Days (~182 Calendar Days)
```

这告诉了我们胜率的底线。我们选择的期权到期日必须远于这个时间。

---

## 4. Step 0.5: 寻找完美合约 (The Solver) —— 进阶选品

**对应脚本**：`code/strategies/optimal_expiry_solver.py`

在 Step 0 知道了胜率底线之后，如果你对"到底买哪个月的期权"感到纠结，可以使用这个工具。它通过暴力扫描寻找数学上的甜蜜点 (Sweet Spot)。

### 4.1 核心逻辑：攻守平衡

这个脚本在寻找两条曲线的交点：

#### 进攻曲线 (Blue Line): 0.5 * Kelly Ratio

随着期限延长，波动率降低，凯利公式建议的仓位会逐渐增加。这是你的"贪婪"。

#### 防守曲线 (Red Line): Pilot Position Cap

这是一个硬性风控逻辑："我现在的仓位，必须保证如果在 $V_{fill}$ (补仓价) 发生暴跌，我有足够的现金进行 1:1 的补仓。"

随着期限延长，期权变贵，为了留足补仓的钱，你现在能买的仓位上限会逐渐降低。这是你的"恐惧"。

**两条线的交点，就是最优解**：既满足了凯利增长的要求，又保留了完美的补仓后手。

### 4.2 结果使用 (关键步骤！)

运行脚本后，你会得到一个最优期限（例如 457天）。

**行动指南**：

1. 去期权链上寻找距离这个天数最近的到期日。
2. **重要回代**：将该合约的实际价格和参数（Price, Delta, Theta），填回到 Step 1 的 `single_asset_kelly.py` 中，作为最终计算依据。

⚠️ **Solver 只是指路人，Kelly 才是最终的裁决者。**

---

## 5. Step 1: 计算最优仓位 (Kelly Calculator)

**对应脚本**：`code/strategies/single_asset_kelly.py`

这是整个系统的心脏。在明确了 Lambda 的合理范围（Step 0）和选定了具体的期权合约后，我们进入核心计算。

### 5.1 参数输入流程

请严格按照以下顺序进行思考和录入。

#### A. 自动获取 (Objective Data) —— 📍 不需要你动

程序会自动从 Yahoo Finance 和本地 CSV 计算这些统计特征，代表了市场的客观状态。

| 参数 | 代码变量 | 含义 | 来源 | 注意事项 |
|------|----------|------|------|----------|
| 回归速度 | `lambda_annual` | 股价偏离后回归均值的速度。数值越大，修复越快，预期收益越高。 | 基于 pe_csv 数据的 OU 过程拟合 | **关键检查**：如果在 Step 0 的图表中发现 Lambda 虚高（例如处于历史 95% 分位数），请在代码中手动将其改小。 |
| 真实波动 | `sigma_iv` | 标的正股的年化波动率（例如 45%）。这是凯利公式的分母（风险）。 | yfinance 过去 3 年历史数据 | 我们强制使用 **85% 分位数** 的保守估计，确保风险（分母）足够大。 |
| 无风险利率 | `r_f` | 资金的机会成本（如 4.1%）。 | 硬编码或 API 获取 | 可参考当前短期美债收益率 |

#### B. 主观决策 (Subjective Inputs) —— 🧠 你的判断

这些参数直接决定了仓位的激进程度，请务必根据个人判断填写：

**1. 目标价 (V) 与 硬底 (V_hard)**

```python
V = 225.00      # 目标价 (Fair Value)
V_hard = 130.00 # 硬底 (Hard Floor) --> 对应 LEAPS 行权价 (Strike)
```

- **V (目标价)**：你认为标的值多少钱？
  - **影响**：$V$ 越高，预期收益 (Drift) 越高，仓位越大。
  - **参考**：历史 PE 中位数、估值上限、或根据 DCF 模型算出的公允价值。

- **V_hard (硬底)**：极端悲观情况下，你认为它绝对不会跌破的价格。
  - **影响**：这决定了你的"信心水位"。股价离 $V_{hard}$ 越近，程序给出的 Alpha 信心系数越高，仓位越重。
  - **参考**：可以是股价如果跌到历史最低 PE 时对应的价格，或者是技术面的强力支撑位。
  - **作用**：这是你的** "止损锚点" **。程序会假设股价接近这个位置时安全度极高，从而加大仓位。
  - **操作**：请务必购买 Strike Price 接近 $V_{hard}$ 的期权，物理上锁死 $V_{hard}$ 以下的尾部风险。

**2. 估值折扣系数 (beta)**

```python
beta = 0.2  # 建议范围: 0.2 ~ 0.5
```

- **含义**：当股价上涨接近目标价 $V$ 时，你要多大程度上减少仓位？
- **逻辑**：
  - **0.0**：死多头模式。即使股价涨到了目标价，Alpha 依然是 1.0，完全不减仓。
  - **1.0**：极度保守。股价一到目标价，Alpha 变成 0，直接清仓。
  - **0.2**：推荐值。保留大部分底仓，以此来对抗右侧踏空的风险。

**3. 凯利系数 (k)**

```python
k = 0.5  # 初次建仓推荐值
```

- **定义**：资金安全倍数。
- **强烈建议**：
  - 初次建仓使用 $k=0.5$ (半凯利)。这是在长期增长和避免归零之间的最佳平衡点。
  - 只有在股价击穿 $V_{hard}$ 的极度恐慌时刻，才考虑使用 $k=1.0$ (全凯利)。

#### C. 市场快照 (Market Snapshot) —— 🛒 填入合约数据

⚠️ **选筹关键规则**：

1. 在录入以下数据前，请先在心中确定 **硬底 ($V_{hard}$)**。
2. 你选择的 LEAPS 合约，其 **行权价 (Strike Price)** 应该 **等于或接近** 你设定的硬底。
3. **原理**：即使股价腰斩，跌破了硬底，你的最大亏损也被行权价锁定了，物理上截断了尾部风险。

打开交易软件（如 IBKR, ThinkOrSwim），找到那张 Strike ≈ $V_{hard}$ 的合约，填入以下数据：

| 参数 | 代码变量 | 说明 |
|------|----------|------|
| 股价 | `P` | 正股当前价格。 |
| 期权价 | `option_price` | 你选定合约的最新价格 (Ask Price)。 |
| Delta | `delta` | 该合约的 Delta 值（通常在 0.8 ~ 0.9 之间）。 |
| Theta | `theta_daily_abs` | 该合约的每日 Theta 损耗（取绝对值）。 |

**提示**：如果你不知道该选哪张合约，可以先参考前文的 "Step 0.5: 寻找完美合约" 章节，找到最优合约后，务必将那张合约的参数回填到本脚本中。

### 5.2 结果解读 (Example Output: Half-Kelly)

以下是 NVDA 的一次真实计算结果。请注意，这里使用了 $k=0.5$ 进行计算，这通常是我们推荐的实战配置。

```
SUCCESS: OU Parameters Fetched (Rolling 90d). Annualized Lambda = 5.8930
[NVDA] current=49.64%, 85%ile=60.82% -> using max => 60.82%
SUCCESS: YF Volatility Fetched. Annualized Sigma = 60.82%

============================================================
🚀 NVDA LEAPS Strategy Calculator (V23.2 Rolling-Lambda)
============================================================
[1. Market Snapshot]
  - Price P:          $182.14
  - Target V:         $225.0 (Hard Floor $130.0)
  - Option Price:     $64.63 (Delta=0.846, Theta=$0.0432)

[2. Statistical Params (Auto-Fetched)]
  - Regression Lambda: 5.89 (90-Day Rolling Window)
  - Real Sigma:        60.82% (Robust 85%ile)

[3. LEAPS Core Attributes]
  - Eff. Leverage L:   2.38x
  - Cost of Capital:   4.1%
  - Time Decay Theta:  16.84% (Annualized)
  - Total Risk SigmaL: 145.01% (Variance 2.10)

[4. Strategy Verdict]
  - Exp. Drift:        296.91% (Stock 124.53%)
  - Net Edge (ERP):    275.97% (After Rf & Theta)
  - Risk Level:        54.9% (Alpha Discount = 0.890)
------------------------------------------------------------
[5. Kelly Suggestion]
  > Allocation %:      58.42%
  > Cash Amount:       $58,416
  > Contracts:         9.04
============================================================
```

**关键解读**：

- **Real Sigma (60.82%)**：模型自动取了 85% 分位数的波动率（当前实际只有 49%），这极大地增加了安全性。
- **Total Risk SigmaL (145.01%)**：加上杠杆后，这个资产的波动率极高。
- **Allocation % (58.42%)**：这是在 **半凯利** ($k=0.5$) 下的建议仓位。
  - **对比**：如果使用全凯利 ($k=1.0$)，这个数值会飙升到 116% 以上，那是极其危险的。58% 的仓位既利用了 LEAPS 的高 ERP 进攻，又保留了 40%+ 的现金作为安全垫，足以应对绝大多数波动。

⚠️ **实战铁律**：永远不要用融资买期权。即使建议 > 100%，请将上限卡在 100%（满仓）或者你账户预设的单标的上限（如 20%）。

---

## 6. Step 2: 压力测试与风控 (Risk Analyzer)

**对应脚本**：`code/strategies/single_asset_risk.py`

**切记**：算出仓位还没完，必须跑风险脚本才算结束。尤其是当 LEAPS 带有杠杆时，账户的波动会比你想象的剧烈。

### 6.1 解读风险报告 (基于上述 k=0.5 仓位)

该脚本会基于 Step 1 的建议仓位，模拟极端情况：

```
============================================================
📊 NVDA LEAPS Risk Analysis
============================================================
[1. Instrument Info]
  - Option Price:        $64.63
  - Effective Leverage:  2.38x
  - Kelly Suggested:     58.42% (Cash $58,416)
------------------------------------------------------------
[2. LEAPS Instrument Volatility]
  - Annualized Volatility: 145.01%
  - Daily Volatility:      9.13%
  - Single Contract Daily Move: $5.90
------------------------------------------------------------
[3. Account Daily Risk]
  - Account Daily Volatility: 5.34%
  - Expected Daily PnL:       ±$5,336
------------------------------------------------------------
[4. Stress Scenarios]

  Scenario             | LEAPS Drop      | Account Loss
  --------------------------------------------------
  Normal Move (1σ)     | -9.08%          | -$5,307
  Monthly Drop (2σ)    | -17.90%         | -$10,459
  Extreme Crash (3σ)   | -23.53%         | -$13,745
============================================================
⚠️ HIGH RISK: Account daily volatility (5.34%) is very high.
   Daily loss could be $5,336.
   Suggestion: Lower k to reduce f_cash.
============================================================
```

**灵魂拷问**：

- **Account Daily Volatility (5.34%)**：即使我们只用了 58% 的仓位，账户整体的日波动率依然高达 5.34%。这相当于全仓持有 3 倍杠杆 ETF 的风险。
- **Extreme Crash (-$13,745)**：问自己：如果明天发生 3σ 级别的黑天鹅，账户瞬间回撤 1.3 万美元，你会恐慌止损吗？如果答案是"会"，请继续降低 $k$ 值（例如降至 0.3）。

**调整**：如果无法承受，请回到 `single_asset_kelly.py`，将 $k$ 从 0.5 下调至 0.3 或更低。

---

## 7. 附录：核心工具原理解析 (Under the Hood)

### 7.1 Lambda Tools (`utils/lambda_tools.py`)

**作用**：计算均值回归的速度 ($\lambda$)。

**关键点**：我们在代码中使用了 **90天滚动窗口** (Rolling 90d)。这能让模型对近期的暴跌反应更灵敏，但也可能带来"噪音"。因此 Step 0 的图表诊断至关重要——**Lambda 宁低不高**。

### 7.2 Sigma Tools (`utils/sigma_tools.py`)

**作用**：计算用于凯利公式分母的波动率 ($\sigma$)。

**设计哲学**：在计算风险（分母）时，我们必须悲观。使用 **85% 分位数** 的波动率，意味着我们假设未来大部分时间市场都会像历史上比较动荡的时期那样波动。这能让计算出的仓位更加安全保守。

---

## 8. 实战执行 SOP：如何分批建仓？

建议采用 **$k$ 值阶梯战法** ($0.5 \to 1.0$)：

### 初次建仓 (Pilot Buy) —— 也就是上面的演示案例

- **触发条件**：股价进入低估区，Step 0 图表显示 Lambda 处于合理区间。
- **参数**：`single_asset_kelly.py` 中设 $k = 0.5$ (半凯利)。
- **结果**：如上文所示，仓位通常在 40%~60% 之间。
- **操作**：买入建议仓位。保留现金。

### 至暗时刻 (The Refill)

- **触发条件**：股价继续下跌，击穿补仓价 ($V_{fill\_plan}$)，甚至接近硬底 ($V_{hard}$)。
- **参数**：将 $k$ 调整为 1.0 (全凯利)。
- **操作**：此时你的"防守资金"（在 Solver 阶段预留的，或半凯利留下的现金）派上用场了。动用现金进行加仓，将仓位打满。

---
