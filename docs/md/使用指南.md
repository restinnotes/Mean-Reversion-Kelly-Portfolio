# Merton-Kelly 量化策略框架使用指南

**关联文档**：本工具的数学原理和推导过程请参考《理论白皮书 (PDF)》。

本指南旨在指导用户如何使用 `code/strategies/` 下的策略脚本以及 `code/utils/` 下的核心分析工具。我们不仅仅是在计算一个仓位数字，更是在执行一套严谨的**"诊断-计算-风控"**流程。

---

## 1. 核心流程与工具全景

在使用任何策略脚本之前,请先理解我们的标准作业程序 (S.O.P.)。**盲目计算仓位而不验证数学假设(均值回归是否成立)是极其危险的。**

| 步骤 | 对应脚本 | 作用 | 核心问题 |
|------|----------|------|----------|
| **Step 0** | `utils/rolling_analysis.py` | 市场诊断 (Diagnosis) | 现在的 Lambda 是否虚高?回归概率如何? |
| **Step 1** | `strategies/single_asset_kelly.py` | 仓位计算 (Sizing) | 基于当前赔率,凯利公式建议买多少? |
| **Step 2** | `strategies/single_asset_risk.py` | 压力测试 (Risk Check) | 如果明天暴跌,我会爆仓吗? |

---

## 2. 环境与准备

### 环境准备

确保你的 Python 环境安装了以下库:

```bash
pip install numpy pandas yfinance matplotlib scipy
```

### 目录结构

确保脚本可以访问 `code/utils/` 文件夹中的工具:

```
project_root/
├── code/
│   ├── strategies/
│   │   ├── single_asset_kelly.py      # 主策略
│   │   └── single_asset_risk.py       # 风控
│   └── utils/
│       ├── lambda_tools.py            # 计算回归动力 (Lambda)
│       ├── sigma_tools.py             # 计算真实波动 (Sigma)
│       └── rolling_analysis.py        # 滚动回归诊断工具
└── pe_csv/
    └── NVDA_pe.csv                     # 历史 PE 数据 (必须有)
```

---

## 3. Step 0: 市场诊断 (The Gatekeeper)

**对应脚本**: `code/utils/rolling_analysis.py`

这是最关键的一步。所有的策略都建立在"均值回归"这一假设上。**在计算仓位之前,我们必须先看清市场的"体温"。**

运行该脚本会生成三张关键图表并输出一份统计报告。

### 3.1 视觉诊断:三张图怎么看? (Visual Diagnosis)

脚本运行后会弹出一个包含三个子图的窗口,这是判断**"Lambda 是否虚高"**的核心依据:

#### Top Plot: PE Ratio vs Moving Avg (估值偏离度)
- **看什么**: 黑线 (当前PE) 是否显著低于 蓝虚线 (均线)。
- **意义**: 确认"低估"是真实的,而不是均线本身在快速下移(价值陷阱)。

#### Middle Plot: Reversion Speed Lambda (回归速度)
- **看什么**: 当前的 Lambda (最右端的值) 是否处于历史极高位?
- **警惕**: Lambda 是一个弹性系数。如果股价最近几天剧烈暴跌又暴涨,拟合出来的 Lambda 可能会飙升(例如 > 8.0 甚至 10.0),但这通常是短期波动的噪音。
- **操作**: 我们宁可低估动力,不可高估。如果图表显示当前 Lambda 远高于历史平均水平,请在后续 Step 1 计算仓位时,手动调低 Lambda(例如取历史平均值或中位数),以防模型过度乐观。

#### Bottom Plot: Implied Half-Life (半衰期)
- **看什么**: 需要多少天才能修复一半的跌幅?
- **意义**: 时间是期权的敌人。如果半衰期在历史高位(例如 > 100天),说明近期股性极慢,LEAPS 的 Theta 损耗可能会吃掉利润。

### 3.2 结果解读 (Statistical Report)

运行脚本后,请关注终端输出的概率表,特别是 `[ACTION PLAN]`:

```
============================================================
 MARKET REGIME DIAGNOSIS: NVDA (2025-11-21)
============================================================
 Current PE       : 25.78  (Avg: 33.19)
 Current Lambda   : 5.8930
 Current Half-Life: 29.64 Days
------------------------------
>>> STARTING VALUATION REPAIR SIMULATION <<<
Goal: Repair from PE 25.78 -> PE 33.19
Using Stats: Lambda=5.89, Sigma=0.9286

[WIN RATE TABLE]
Trading Days  ~Calendar Days  ~Months   Touch Prob  Hold Prob  Expected PE
      21           30d         1.0 Mo      15.0%       9.9%       28.74
      42           60d         2.0 Mo      44.0%      24.6%       30.46
      63           91d         3.0 Mo      63.6%      34.3%       31.54
     126          182d         6.0 Mo      90.3%      45.7%       32.76
     189          273d         9.0 Mo      97.4%      48.5%       33.04
------------------------------------------------------------
RECOMMENDATION:
> [STATISTICAL FLOOR] 90% Probability to touch target within:
   126 Trading Days (~182 Calendar Days)

> [ACTION PLAN] Buy options with Expiry >= 182 DAYS (Approx 6.1 Months)
   * This is the minimum time required for a 90% win rate.
   * Optimization: Choose the FURTHEST expiry available beyond this date.
```

**Statistical Floor (统计底线)**: 这是达到 90% 胜率所需的最短时间。在上面的例子中,至少需要 182 天。

**Action Plan (行动指南)**: 这决定了你接下来去选期权的底线。

⚠️ **切记**: 这只是及格线。在资金允许的情况下,请尽量购买期限更长(例如 1 年以上)的 LEAPS,以获得更高的时间安全边际。

---

## 4. Step 1: 计算最优仓位 (Kelly Calculator)

**对应脚本**: `code/strategies/single_asset_kelly.py`

在明确了 Lambda 的合理范围(Step 0 视觉诊断)和所需的最短期限(Step 0 统计报告)后,我们进入核心计算。

### 4.1 参数输入流程:从想法到合约

请严格按照以下顺序进行思考和录入,切勿本末倒置。

#### A. 自动获取 (Objective Data) —— 📍 不需要你动

程序会自动从 Yahoo Finance 和本地 CSV 计算统计特征。

| 参数 | 含义 | 注意事项 |
|------|------|----------|
| 回归速度 ($\lambda$) | 股价回归均值的速度。 | **关键检查**: 如果在 Step 0 的图表中发现 Lambda 虚高(例如处于历史 95% 分位数),请在代码中手动将其改小。 |
| 真实波动 ($\sigma$) | 标的年化波动率。 | 我们强制使用 **85% 分位数** 的保守估计,确保风险(分母)足够大。 |

#### B. 主观决策 (Subjective Inputs) —— 🧠 先定预期

在打开交易软件之前,你必须先明确你的战场:

**1. 设定 目标价 ($V$) 与 硬底 ($V_{hard}$)**

- **$V_{hard}$ (硬底)**: 极端悲观情况下,你认为它绝对不会跌破的价格。
  - **作用**: 这是你的**"止损锚点"**。它将直接决定你去买哪一张期权。
- **$V$ (目标价)**: 合理的估值回归目标。

**2. 设定 凯利系数 ($k$)**

建议值:
- 初次建仓 $k=0.5$
- 击穿硬底时的至暗时刻 $k=1.0$

#### C. 市场快照 (Market Snapshot) —— 🛒 后选合约

有了 B 步骤确定的 $V_{hard}$ 和 Step 0 确定的期限,现在去选期权:

**行权价 (Strike)**: 寻找 Strike $\approx V_{hard}$ 的合约。
- **原理**: 物理上锁死 $V_{hard}$ 以下的尾部风险。

**到期日 (Expiry)**: 寻找 Expiry > Step 0 建议的最短期限 的合约。
- **原则**: 越长越好。尽量选择最远期的 LEAPS。

填入这张合约的数据:
- `option_price` (Ask Price)
- `delta`
- `theta` (绝对值)

### 4.2 结果解读 (Example Output)

以下是 NVDA 的一次真实计算结果(注意其中的 Net Edge 和 Allocation):

```
SUCCESS: OU Parameters Fetched (Rolling 90d).
         Annualized Lambda = 5.8930
         [NVDA] current=49.64%, 85%ile=60.82% -> using max => 60.82%

SUCCESS: YF Volatility Fetched.
         Annualized Sigma = 60.82%

============================================================
🚀 NVDA LEAPS Strategy Calculator (V23.2 Rolling-Lambda)
============================================================
[1. Market Snapshot]
  - Price P:         $182.14
  - Target V:        $225.0  (Hard Floor $130.0)
  - Option Price:    $64.63  (Delta=0.846, Theta=$0.0432)

[2. Statistical Params (Auto-Fetched)]
  - Regression Lambda: 5.89   (90-Day Rolling Window)
  - Real Sigma:        60.82% (Robust 85%ile)

[3. LEAPS Core Attributes]
  - Eff. Leverage L:   2.38x
  - Cost of Capital:   4.1%
  - Time Decay Theta:  16.84% (Annualized)
  - Total Risk SigmaL: 145.01% (Variance 2.10)

[4. Strategy Verdict]
  - Exp. Drift:        296.91% (Stock 124.53%)
  - Net Edge (ERP):    275.97% (After Rf & Theta)
  - Risk Level:        54.9%  (Alpha Discount = 0.890)

------------------------------------------------------------
[5. Kelly Suggestion]
  > Allocation %:      116.83%
  > Cash Amount:       $116,833
  > Contracts:         18.08
============================================================
```

**关键解读**:

- **Real Sigma (60.82%)**: 模型自动取了 85% 分位数的波动率(当前实际只有 49%),这极大地增加了安全性。
- **Total Risk SigmaL (145.01%)**: 加上杠杆后,这个资产的波动率极高。
- **Allocation % (116.83%)**: 即使风险这么高,由于 ERP 高达 275%,模型依然建议满仓。

⚠️ **实战铁律**: 永远不要用融资买期权。即使建议 > 100%,请将上限卡在 100%(满仓)或者你账户预设的单标的上限(如 20%)。

---

## 5. Step 2: 压力测试与风控 (Risk Analyzer)

**对应脚本**: `code/strategies/single_asset_risk.py`

**切记**: 算出仓位还没完,必须跑风险脚本才算结束。尤其是当模型建议 > 100% 仓位时,你必须知道这背后的代价。

### 5.1 解读风险报告

该脚本会基于 Step 1 的建议仓位,模拟极端情况:

```
============================================================
📊 NVDA LEAPS Risk Analysis
============================================================
[1. Instrument Info]
  - Option Price:        $64.63
  - Effective Leverage:  2.38x
  - Kelly Suggested:     116.83%  (Cash $116,833)

------------------------------------------------------------
[2. LEAPS Instrument Volatility]
  - Annualized Volatility: 145.01%
  - Daily Volatility:      9.13%
  - Single Contract Daily Move: $5.90

------------------------------------------------------------
[3. Account Daily Risk]
  - Account Daily Volatility: 10.67%
  - Expected Daily PnL:       ±$10,672

------------------------------------------------------------
[4. Stress Scenarios]
Scenario             | LEAPS Drop | Account Loss
--------------------------------------------------
Normal Move (1σ)     |   -9.08%   |  -$10,613
Monthly Drop (2σ)    |  -17.90%   |  -$20,918
Extreme Crash (3σ)   |  -23.53%   |  -$27,490

============================================================
⚠️ HIGH RISK: Account daily volatility (10.67%) is very high.
Daily loss could be $10,672.
Suggestion: Lower k to reduce f_cash.
============================================================
```

**关键指标**:

- **Account Daily Risk (10.67%)**: 这意味着你的总账户一天可能波动 10%。
- **Extreme Crash (-$27,490)**: 问自己:如果明天一睁眼少了 2.7 万美元,你会不会恐慌卖出?

**调整**: 如果无法承受,请回到 `single_asset_kelly.py`,将 $k$ 从 1.0 下调至 0.5 或 0.3。

---

## 6. 附录:核心工具原理解析 (Under the Hood)

### 6.1 Lambda Tools (`utils/lambda_tools.py`)

**作用**: 计算均值回归的速度 ($\lambda$)。

**关键点**: 我们在代码中使用了 **90天滚动窗口** (Rolling 90d)。这能让模型对近期的暴跌反应更灵敏,但也可能带来"噪音"。因此 Step 0 的图表诊断至关重要——**Lambda 宁低不高**。

### 6.2 Sigma Tools (`utils/sigma_tools.py`)

**作用**: 计算用于凯利公式分母的波动率 ($\sigma$)。

**设计哲学**: 在计算风险(分母)时,我们必须悲观。使用 **85% 分位数** 的波动率,意味着我们假设未来大部分时间市场都会像历史上比较动荡的时期那样波动。这能让计算出的仓位更加安全保守。

---

## 7. 实战执行 SOP:如何分批建仓?

建议采用 **$k$ 值阶梯战法** ($0.5 \to 1.0$):

### 初次建仓 (Pilot Buy)

- **触发条件**: 股价进入低估区,Step 0 图表显示 Lambda 处于合理区间。
- **参数**: $k = 0.5$ (半凯利)。
- **操作**: 买入 50% 的建议仓位。保留现金。

### 至暗时刻 (The All-In)

- **触发条件**: 股价击穿硬底 ($V_{hard}$),市场极度恐慌,Step 0 显示回归概率依然极高。
- **参数**: $k = 1.0$ (全凯利)。
- **操作**: 动用剩余现金打满仓位。

---

**祝交易顺利,活得长久。**