import streamlit as st

def render_page_glossary():
    st.title("📚 术语与原理速查")
    st.markdown("---")

    # ==============================================================================
    # 1. 核心公式
    # ==============================================================================
    st.header("1. 核心公式与概念")

    with st.expander("Merton-Kelly 连续时间公式 (修正版)", expanded=True):
        st.markdown(r"""
        本策略的核心是基于 Merton (1969) 优化的连续时间凯利公式。

        **最终仓位比例 $f_{Kelly}$ 计算如下：**

        $$
        f_{Kelly} = k \cdot \frac{\nu(P) - r_f - \theta_{annual}}{L^2 \cdot \sigma^2} \cdot \alpha(P)
        $$

        **公式拆解：**
        * **$k$ (Kelly Factor)**：**激进系数**。您手中的“油门”，用于整体缩放仓位。
        * **分子 (Net Edge)**：$\nu(P) - r_f - \theta_{annual}$。代表扣除资金成本和期权租金后的**净优势**。
        * **分母 (Risk)**：$L^2 \cdot \sigma^2$。代表**方差**。注意这里杠杆 $L$ 是平方级放大的。
        * **$\alpha(P)$ (Alpha)**：**信心系数**。当股价接近目标价时，自动降低仓位权重。
        """)

    # ==============================================================================
    # 2. 关键参数字典 (使用 Markdown 列表代替表格，避免渲染错误)
    # ==============================================================================
    st.header("2. 关键参数字典")

    st.subheader("📊 统计参数 (自动获取)")

    st.markdown(r"""
    **Lambda ($\lambda$) - 回归动力**
    > 衡量股价被“拉回”均值的速度。$\lambda$ 越高，修复越快，预期收益越高。

    **Sigma ($\sigma$) - 历史波动率**
    > 凯利公式的分母（风险项）。我们采用历史 85% 分位数以保持保守。
    """)

    st.divider()

    st.subheader("🎛️ 策略参数 (用户设定)")

    # 使用 st.columns 进行整齐排列，比表格更灵活且不易出错
    col1, col2 = st.columns(2)

    with col1:
        st.markdown(r"""
        **Target Price ($V_{target}$)**
        * **含义**：目标价/公允价值。
        * **作用**：决定了预期的上涨空间 (Drift)。通常参考历史估值中枢。

        **Kelly Factor ($k$)**
        * **含义**：激进系数。
        * **推荐**：工程上推荐 **$k=0.5$ (半凯利)**。
        * **效果**：可将波动率降低 50%，同时保留 75% 的长期复利增长。
        """)

    with col2:
        st.markdown(r"""
        **Beta ($\beta$) - 估值折扣/止盈速率**
        * 控制当 $P \to V_{target}$ 时仓位降低的程度。
        * $\beta=0$：不减仓（Alpha恒为1）。
        * $\beta=1$：到目标价即清仓（Alpha降为0）。
        * **推荐 0.2**：保留底仓，适度止盈。

        **Hard Floor ($V_{hard}$)**
        * **含义**：硬底/止损锚点。
        * **作用**：您认为绝对不会跌破的价格。模型会假设在接近此价格时胜率极高，从而加大仓位。
        """)

    st.divider()

    st.subheader("📈 输出指标")

    st.markdown(r"""
    **1. ERP (Net Edge) - 净优势**
    * **公式**：$\text{Drift} \times L - r_f - \theta$
    * **含义**：扣除资金成本 ($r_f$) 和时间损耗 ($\theta$) 后的超额收益。
    * **决策**：**必须 > 0** 方可开仓。

    **2. Alpha ($\alpha$) - 信心系数**
    * **含义**：基于当前价格在 $[V_{hard}, V_{target}]$ 区间的位置计算的折扣。
    * **决策**：越接近 1.0 越好，表示越接近底部。

    **3. Leverage ($L$) - 有效杠杆**
    * **含义**：期权价格变化相对于正股变化的倍数。
    * **公式**：

    $$
    \Omega = \Delta \times \frac{S}{C}
    $$

    * **参考**：通常 LEAPS 在 2x ~ 3x 之间。
    """)

    # ==============================================================================
    # 3. FAQ
    # ==============================================================================
    st.header("3. 常见问题 (FAQ)")
    st.info(r"""
    **Q: 为什么 ERP 会是负的？**
    A: 通常有两个原因：
    1. 股价不够低，回归动力 ($\lambda$) 不足以覆盖成本。
    2. 期权太贵，或者选的合约时间太短，导致时间损耗 ($\theta$) 极其巨大。

    **Q: 为什么系统建议的仓位超过了 100%？**
    A: 凯利公式计算的是“最优杠杆率”。如果结果是 150%，意味着数学上您应该借钱买入。但**实战中请务必将上限卡在 100%**，或通过降低 $k$ 值来控制风险。
    """)